{% extends "base/base.html" %}
{% load static %}

{% block content %}
<style>
  body { background:#0f172a; color:#e2e8f0; font-family:'Segoe UI', sans-serif; }
  .inbox-wrap { max-width:1100px; margin:80px auto 40px; padding:0 20px; }

  .inbox-head {
    display:flex; align-items:center; justify-content:space-between; margin-bottom:22px;
  }
  .inbox-title { font-size:2.2rem; font-weight:800; color:#14b8a6; display:flex; align-items:center; gap:10px; }
  .inbox-title::after {
    content:""; display:block; height:4px; width:50px; background:#14b8a6; border-radius:4px;
  }

  .search {
    background:rgba(255,255,255,0.08); border:1px solid rgba(255,255,255,0.15);
    color:#fff; padding:11px 16px; border-radius:14px; width:330px; outline:none;
    transition:.25s ease; font-size:.95rem;
  }
  .search:focus { border-color:#14b8a6; box-shadow:0 0 0 4px rgba(20,184,166,.2); }

  .list { display:grid; gap:16px; }
  .row {
    display:flex; align-items:center; gap:14px;
    background:rgba(30,41,59,0.7); backdrop-filter:blur(14px);
    border:1px solid rgba(255,255,255,0.12); border-radius:18px; padding:16px 18px;
    transition:.25s ease; cursor:pointer;
  }
  .row:hover { transform:translateY(-2px) scale(1.01); border-color:#14b8a6; box-shadow:0 10px 28px rgba(0,0,0,.45); }

  .avatar {
    height:52px; width:52px; border-radius:50%; flex-shrink:0;
    background:linear-gradient(135deg,#0ea5e9,#3b82f6);
    display:flex; align-items:center; justify-content:center;
    font-weight:800; color:white; font-size:1.1rem; position:relative;
  }
  .status-dot {
    position:absolute; bottom:4px; right:4px; height:12px; width:12px; border-radius:50%;
    border:2px solid #0f172a; background:#22c55e;
  }
  .info { flex:1; min-width:0; }
  .name { font-weight:800; font-size:1.05rem; color:#f8fafc; display:flex; align-items:center; gap:6px; }
  .meta { font-size:.82rem; color:#94a3b8; }
  .preview {
    font-size:.92rem; color:#cbd5e1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
  }
  .time { font-size:.78rem; color:#94a3b8; text-align:right; }
  .badge {
    background:#ef4444; color:white; font-size:.7rem; padding:2px 8px;
    border-radius:9999px; font-weight:700; margin-top:6px; text-align:center;
    display:inline-block; box-shadow:0 2px 8px rgba(239,68,68,.4);
  }
  .open-btn {
    margin-top:8px; padding:9px 14px; border-radius:12px; font-weight:700; color:white;
    background:#6366f1; border:1px solid rgba(255,255,255,0.15);
    transition:.25s ease; text-align:center;
  }
  .open-btn:hover { background:#4f46e5; transform:translateY(-1px); box-shadow:0 8px 20px rgba(79,70,229,.4); }

  .empty {
    text-align:center; margin-top:60px; color:#94a3b8;
  }
  .empty img { max-width:220px; margin-bottom:16px; opacity:.85; }

  @media (max-width:640px) {
    .inbox-head { flex-direction:column; align-items:flex-start; gap:12px; }
    .search { width:100%; }
    .row { flex-direction:column; align-items:flex-start; }
    .time { text-align:left; }
  }
</style>

<div class="inbox-wrap ">
  <div class="inbox-head ">
    <h1 class="inbox-title mt-16">💬 Inbox</h1>
    <input id="search" class="search" placeholder="🔍 Search by name, email, department..." />
  </div>

  <div id="list" class="list">
    {% if conversations %}
      {% for c in conversations %}
        {% with p=c.partner %}
        <div class="row" data-keywords="{{ p.full_name }} {{ p.university_email }} {{ p.department }}">
          <div class="avatar">
            {{ p.full_name|default:p.university_email|slice:":1"|upper }}
            <span class="status-dot"></span>  {# online indicator (optional you can set conditionally) #}
          </div>

          <div class="info">
            <div class="name">
              {{ p.full_name|default:p.university_email }}
              {% if c.unread_count and c.unread_count > 0 %}
                <span class="badge">{{ c.unread_count }}</span>
              {% endif %}
            </div>
            <div class="meta">
              {{ p.department|default:"" }} {% if p.department %}•{% endif %} {{ p.university_email }}
            </div>
            <div class="preview">
              {% if c.last_sender == request.user %}You: {% endif %}{{ c.last_message }}
            </div>
          </div>

          <div style="text-align:right; display:flex; flex-direction:column; gap:6px;">
            <div class="time">{{ c.last_time|date:"M d, H:i" }}</div>
            <a href="{% url 'chat_with_user' p.id %}" class="open-btn">Open Chat →</a>
          </div>
        </div>
        {% endwith %}
      {% endfor %}
    {% else %}
      <div class="empty">
        <img src="{% static 'images/empty-chat.svg' %}" alt="No chats">
        <p>No conversations yet. Start connecting 📭</p>
      </div>
    {% endif %}
  </div>
</div>

<script>
  const input = document.getElementById('search');
  const rows = Array.from(document.querySelectorAll('#list .row'));
  input.addEventListener('input', () => {
    const q = input.value.toLowerCase();
    rows.forEach(r => {
      const k = (r.getAttribute('data-keywords') || '').toLowerCase();
      r.style.display = k.includes(q) ? '' : 'none';
    });
  });
</script>
{% endblock %}
